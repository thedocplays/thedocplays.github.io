<!DOCTYPE html>
<html lang="en">
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MFSXNSZ11C"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MFSXNSZ11C');
</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#121212">
    <title>Heritage Commander Oracle</title>
    <style>
        :root { --bg: #121212; --surface: #1e1e1e; --border: #333; --text-primary: #e0e0e0; --text-secondary: #a0a0a0; --accent: #d4af37; --legal: #4caf50; --illegal: #f44336; --banned: #b71c1c; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text-primary); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        
        /* HEADER */
        .header { text-align: center; margin-bottom: 30px; width: 100%; max-width: 700px; position: relative; }
        h1 { color: var(--accent); text-transform: uppercase; letter-spacing: 3px; font-size: 2.2rem; margin: 0 0 10px 0; }
        .subtitle { color: var(--text-secondary); font-style: italic; font-size: 0.9rem; margin-bottom: 20px; }
        
        .nav-bar { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-btn {
            background: transparent; color: var(--text-secondary); border: 1px solid #444;
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s;
        }
        .nav-btn:hover { border-color: var(--accent); color: var(--accent); }
        .cmd-btn { border-color: #664d00; color: #d4af37; }
        .cmd-btn:hover { background: rgba(212, 175, 55, 0.1); box-shadow: 0 0 10px rgba(212, 175, 55, 0.2); }
        .deck-btn { border-color: var(--legal); color: var(--legal); }
        .deck-btn:hover { background: rgba(76, 175, 80, 0.1); }

        /* SEARCH AREA */
        .search-wrapper { width: 100%; max-width: 700px; position: relative; z-index: 100; margin-bottom: 20px; }
        .input-container { position: relative; width: 100%; }
        
        input[type="text"], input[type="number"], select { 
            width: 100%; padding: 15px; font-size: 1.1rem; 
            background: var(--surface); border: 2px solid var(--border); 
            border-radius: 8px; color: white; box-sizing: border-box; 
        }
        select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23d4af37%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto; }
        input:focus, select:focus { outline: none; border-color: var(--accent); }

        /* SUGGESTIONS */
        .suggestions-box {
            position: absolute; top: 100%; left: 0; width: 100%;
            background: #252525; border: 1px solid var(--border); border-top: none;
            border-radius: 0 0 12px 12px; overflow: hidden; display: none;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 2000;
        }
        .suggestion-item {
            padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #333;
            color: #ccc; display: flex; justify-content: space-between;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: var(--accent); color: #000; font-weight: bold; }

        /* ADVANCED PANEL */
        .adv-toggle { text-align: right; margin-top: 10px; cursor: pointer; color: var(--accent); font-size: 0.9rem; text-decoration: underline; }
        .adv-panel { background: #252525; border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-top: 10px; display: none; }
        
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .filter-group { display: flex; flex-direction: column; position: relative; }
        .filter-label { font-size: 0.7rem; color: #888; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .full-width { grid-column: 1 / -1; }

        /* MANA ICONS */
        .color-row { display: flex; gap: 8px; flex-wrap: wrap; }
        .mana-check-input { display: none; }
        .mana-icon { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; opacity: 0.3; transition: all 0.2s; border: 2px solid transparent; padding: 2px; }
        .mana-icon:hover { opacity: 0.8; transform: scale(1.1); }
        .mana-check-input:checked + .mana-icon { opacity: 1; border-color: var(--accent); box-shadow: 0 0 10px var(--accent); transform: scale(1.1); }

        /* RESULTS AREA */
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; width: 100%; max-width: 1000px; margin-top: 40px; }
        .mini-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .mini-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .mini-img { width: 100%; height: auto; display: block; }
        .mini-info { padding: 10px; text-align: center; }
        .mini-name { font-weight: bold; font-size: 0.85rem; display: block; }
        .mini-set { font-size: 0.7rem; color: #888; }
        
        /* CARD DISPLAY */
        .card-display { 
            background: var(--surface); border: 1px solid var(--border); border-radius: 16px; 
            padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            display: none; max-width: 450px; width: 100%; margin-top: 20px;
        }
        .card-image-container { width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 20px; background: #222; min-height: 300px; position: relative; }
        .card-img { width: 100%; height: auto; display: block; }
        
        .status-badge { display: inline-block; padding: 8px 20px; border-radius: 50px; font-size: 1.2rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; }
        .legal { background: rgba(76, 175, 80, 0.1); color: var(--legal); border: 2px solid var(--legal); }
        .illegal { background: rgba(244, 67, 54, 0.1); color: var(--illegal); border: 2px solid var(--illegal); }
        .banned { background: rgba(183, 28, 28, 0.1); color: #ff5252; border: 2px solid #ff5252; }

        .oracle-box { text-align: left; background: rgba(255, 255, 255, 0.05); border: 1px solid #444; border-radius: 8px; padding: 15px; margin-bottom: 15px; font-size: 0.95rem; line-height: 1.5; white-space: pre-wrap; }
        .set-display { display: flex; align-items: center; justify-content: center; gap: 8px; color: var(--accent); margin-top: 10px; font-size: 1rem; }
        .set-icon { width: 24px; height: 24px; fill: var(--accent); }

        .action-row { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .action-btn { background: #333; color: white; border: 1px solid #555; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: bold; text-decoration: none; display: inline-block; transition: all 0.2s; }
        .action-btn:hover { background: var(--accent); color: black; border-color: var(--accent); }
        .add-btn { background: var(--legal); border-color: var(--legal); color: #000; }
        .add-btn:hover { background: #388e3c; color: white; }

        .reset-btn { margin-top: 15px; width: 100%; background: transparent; border: 1px solid #666; color: #888; }
        .reset-btn:hover { background: #333; color: white; }

        .load-more-btn { grid-column: 1 / -1; margin: 30px auto; padding: 12px 30px; background: #333; color: white; border: 1px solid #555; border-radius: 30px; font-weight: bold; cursor: pointer; display: none; }
        .load-more-btn:hover { background: var(--accent); color: black; border-color: var(--accent); }
        .results-status { grid-column: 1 / -1; text-align: center; color: #888; margin-bottom: 10px; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; border: 1px solid var(--accent); position: relative; max-height: 80vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #888; }
        .modal-content h2 { color: var(--accent); margin-top: 0; }
        .modal-content ul { padding-left: 20px; line-height: 1.6; color: #ccc; }

        /* DECK LIST STYLES */
        .deck-list { list-style: none; padding: 0; margin-top: 20px; }
        .deck-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; align-items: center; }
        .deck-item span { color: #fff; }
        .remove-btn { color: #f44336; cursor: pointer; font-weight: bold; font-size: 1.2rem; padding: 0 10px; }
        .deck-actions { display: flex; gap: 10px; margin-top: 20px; }
        .copy-btn { flex: 1; background: var(--accent); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .clear-btn { background: transparent; border: 1px solid #f44336; color: #f44336; padding: 12px; border-radius: 8px; cursor: pointer; }

        .footer { margin-top: 50px; color: #444; font-size: 0.8rem; text-align: center; }
        .footer a { color: #666; text-decoration: none; }
        .footer a:hover { color: var(--accent); }

    </style>
    <script src="heritage_db.js"></script>
</head>
<body>

    <div class="header">
        <h1>The Heritage Oracle</h1>
        <div class="subtitle">Restoring the Canon of Commander</div>
        
        <div class="nav-bar">
            <button class="nav-btn" onclick="openModal('rulesModal')">Rules</button>
            <button class="nav-btn deck-btn" onclick="openDeck()">Deck (<span id="deckCount">0</span>)</button>
            <button class="nav-btn" onclick="randomCard()">Random ðŸŽ²</button>
            <button class="nav-btn cmd-btn" onclick="randomCommander()">Commander ðŸ‘‘</button>
        </div>
    </div>

    <div id="rulesModal" class="modal-overlay" onclick="closeModal(event, 'rulesModal')">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('rulesModal').style.display='none'">&times;</span>
            <h2>Heritage Protocol</h2>
            <p>A card is legal if it was printed in a <strong>Standard-legal set</strong> (formerly Type 2) set within the Magic Multiverse.</p>
            <ul>
                <li><strong>Allowed:</strong> All Standard sets (Alpha to present).</li>
                <li><strong>Banned:</strong> Commander Precons, Modern Horizons, Supplemental Sets, and Universes Beyond.</li>
                <li><strong>Ban List:</strong> Uses the official Commander Ban List.</li>
            </ul>
        </div>
    </div>

    <div id="deckModal" class="modal-overlay" onclick="closeModal(event, 'deckModal')">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('deckModal').style.display='none'">&times;</span>
            <h2>Current Deck</h2>
            <div id="deckListContainer" class="deck-list"></div>
            
            <div class="deck-actions">
                <button class="copy-btn" onclick="exportDeck()">ðŸ“‹ Copy List</button>
                <button class="clear-btn" onclick="clearDeck()">Clear</button>
            </div>
            <p style="font-size:0.8rem; color:#888; margin-top:10px; text-align:center;">Paste directly into Scryfall, Moxfield, or Archidekt.</p>
        </div>
    </div>

    <div class="search-wrapper">
        <div class="input-container">
            <input type="text" id="mainSearch" placeholder="Search by Name (e.g. Sol Ring)..." autocomplete="off">
            <div id="mainSuggestions" class="suggestions-box"></div>
        </div>
        
        <div class="adv-toggle" onclick="toggleAdv()">+ Advanced Search</div>
        
        <div id="advPanel" class="adv-panel">
            <div class="filter-grid">
                
                <div class="filter-group full-width">
                    <span class="filter-label">Rules Text / Abilities</span>
                    <input type="text" id="rulesInput" placeholder="e.g. Destroy all creatures, Hexproof, Add {G}" autocomplete="off">
                </div>

                <div class="filter-group">
                    <span class="filter-label">Card Type</span>
                    <input type="text" id="typeInput" placeholder="e.g. Elf, Artifact" autocomplete="off">
                    <div id="typeSuggestions" class="suggestions-box"></div>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Set Name</span>
                    <input type="text" id="setInput" placeholder="e.g. Mirage" autocomplete="off">
                    <div id="setSuggestions" class="suggestions-box"></div>
                </div>
                
                <div class="filter-group">
                    <span class="filter-label">Mana Value (CMC)</span>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="cmcMin" placeholder="Min" style="width: 50%;">
                        <input type="number" id="cmcMax" placeholder="Max" style="width: 50%;">
                    </div>
                </div>

                <div class="filter-group">
                    <span class="filter-label">Sort By</span>
                    <select id="sortSelect">
                        <option value="name">Name (A-Z)</option>
                        <option value="cmc-asc">Mana Value (Low to High)</option>
                        <option value="cmc-desc">Mana Value (High to Low)</option>
                        <option value="date">Release Date (Old to New)</option>
                    </select>
                </div>

                <div class="filter-group full-width">
                    <span class="filter-label">Exact Colors / Type</span>
                    <div class="color-row">
                        <label><input type="checkbox" class="mana-check-input" value="W"><img src="https://svgs.scryfall.io/card-symbols/W.svg" class="mana-icon" title="White"></label>
                        <label><input type="checkbox" class="mana-check-input" value="U"><img src="https://svgs.scryfall.io/card-symbols/U.svg" class="mana-icon" title="Blue"></label>
                        <label><input type="checkbox" class="mana-check-input" value="B"><img src="https://svgs.scryfall.io/card-symbols/B.svg" class="mana-icon" title="Black"></label>
                        <label><input type="checkbox" class="mana-check-input" value="R"><img src="https://svgs.scryfall.io/card-symbols/R.svg" class="mana-icon" title="Red"></label>
                        <label><input type="checkbox" class="mana-check-input" value="G"><img src="https://svgs.scryfall.io/card-symbols/G.svg" class="mana-icon" title="Green"></label>
                        <label><input type="checkbox" class="mana-check-input" value="C"><img src="https://svgs.scryfall.io/card-symbols/C.svg" class="mana-icon" title="Colorless"></label>
                        <label><input type="checkbox" class="mana-check-input" value="LAND"><div class="mana-icon" style="background:#444; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white; font-size:10px;">LAND</div></label>
                    </div>
                </div>
            </div>
            
            <button onclick="runAdvancedSearch()" style="width:100%; margin-top:15px; padding:10px; background:var(--accent); border:none; border-radius:5px; font-weight:bold; cursor:pointer;">SEARCH DATABASE</button>
            <button onclick="resetFilters()" class="action-btn reset-btn">Reset Filters</button>
        </div>
    </div>

    <div id="cardDisplay" class="card-display">
        <div class="card-image-container"><img id="cardImg" class="card-img" src=""></div>
        
        <div class="action-row">
            <button id="addDeckBtn" class="action-btn add-btn" onclick="addToDeck()">+ ADD TO DECK</button>
            <button id="flipBtn" class="action-btn" onclick="flipCard()" style="display:none;">â†» FLIP</button>
            <a id="scryfallBtn" class="action-btn" href="#" target="_blank">SCRYFALL â†—</a>
        </div>

        <h2 id="cardName" style="margin-top:0;"></h2>
        <div id="typeLine" style="color:#aaa; font-style:italic; margin-bottom:15px;"></div>
        <div id="oracleText" class="oracle-box"></div>
        <div id="statusBadge" class="status-badge"></div>
        
        <div id="setInfo" class="set-display"></div>
        <div id="msgText" style="margin-top: 15px; color: #888;"></div>
    </div>

    <div id="resultsContainer">
        <div id="advResults" class="results-grid"></div>
        <div id="statusText" class="results-status"></div>
        <button id="loadMoreBtn" class="load-more-btn" onclick="loadMore()">LOAD MORE RESULTS</button>
    </div>

    <div class="footer">
        Database Version: 14.0 (Onyx Release)<br>
        Card data powered by <a href="https://scryfall.com" target="_blank">Scryfall</a>
    </div>

    <script>
        // DOM ELEMENTS
        const input = document.getElementById('mainSearch');
        const mainSuggestions = document.getElementById('mainSuggestions');
        const display = document.getElementById('cardDisplay');
        const advResults = document.getElementById('advResults');
        const flipBtn = document.getElementById('flipBtn');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const statusText = document.getElementById('statusText');
        const scryfallBtn = document.getElementById('scryfallBtn');
        const addDeckBtn = document.getElementById('addDeckBtn');
        const deckCountSpan = document.getElementById('deckCount');
        const deckListContainer = document.getElementById('deckListContainer');

        // ADVANCED INPUTS
        const rulesInput = document.getElementById('rulesInput');
        const typeInput = document.getElementById('typeInput');
        const typeSuggestions = document.getElementById('typeSuggestions');
        const setInput = document.getElementById('setInput');
        const setSuggestions = document.getElementById('setSuggestions');
        const sortSelect = document.getElementById('sortSelect');

        // STATE
        let currentCard = null;
        let isFlipped = false;
        let allMatches = [];
        let displayedCount = 0;
        const BATCH_SIZE = 50;
        let myDeck = JSON.parse(localStorage.getItem('heritageDeck')) || [];

        // --- INIT ---
        updateDeckCount(); // Load saved count

        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const cardParam = params.get('card');
            
            if (typeof HERITAGE_DB !== 'undefined' && cardParam) {
                const decoded = decodeURIComponent(cardParam).toLowerCase();
                const card = HERITAGE_DB.find(c => c.n.toLowerCase() === decoded);
                if (card) {
                    input.value = card.n;
                    selectCard(card);
                } else {
                    input.value = decodeURIComponent(cardParam);
                    input.dispatchEvent(new Event('input'));
                }
            }
        };

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(e, id) { if(e.target === document.getElementById(id)) document.getElementById(id).style.display = 'none'; }

        // --- DECK BUILDER LOGIC ---
        function addToDeck() {
            if (!currentCard) return;
            myDeck.push(currentCard.n);
            saveDeck();
            updateDeckCount();
            
            // Visual Feedback
            const originalText = addDeckBtn.innerText;
            addDeckBtn.innerText = "ADDED!";
            addDeckBtn.style.background = "#fff";
            setTimeout(() => {
                addDeckBtn.innerText = originalText;
                addDeckBtn.style.background = "";
            }, 1000);
        }

        function removeFromDeck(index) {
            myDeck.splice(index, 1);
            saveDeck();
            updateDeckCount();
            renderDeckList(); // Refresh the list
        }

        function clearDeck() {
            if(confirm("Clear your entire deck?")) {
                myDeck = [];
                saveDeck();
                updateDeckCount();
                renderDeckList();
            }
        }

        function saveDeck() {
            localStorage.setItem('heritageDeck', JSON.stringify(myDeck));
        }

        function updateDeckCount() {
            deckCountSpan.innerText = myDeck.length;
        }

        function openDeck() {
            renderDeckList();
            openModal('deckModal');
        }

        function renderDeckList() {
            deckListContainer.innerHTML = '';
            if (myDeck.length === 0) {
                deckListContainer.innerHTML = '<p style="text-align:center; color:#666;">Deck is empty.</p>';
                return;
            }
            
            // Count quantities
            const counts = {};
            myDeck.forEach(name => { counts[name] = (counts[name] || 0) + 1; });
            
            // Convert to array and sort
            const sortedNames = Object.keys(counts).sort();

            sortedNames.forEach(name => {
                const item = document.createElement('div');
                item.className = 'deck-item';
                item.innerHTML = `
                    <span>${counts[name]}x ${name}</span>
                    <span class="remove-btn" onclick="removeByName('${name}')">&times;</span>
                `;
                deckListContainer.appendChild(item);
            });
        }

        // Helper to remove one instance of a card by name
        window.removeByName = function(name) {
            const index = myDeck.indexOf(name);
            if (index > -1) {
                removeFromDeck(index);
            }
        }

        function exportDeck() {
            const counts = {};
            myDeck.forEach(name => { counts[name] = (counts[name] || 0) + 1; });
            
            let text = "";
            Object.keys(counts).sort().forEach(name => {
                text += `${counts[name]} ${name}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                alert("Deck list copied to clipboard!");
            });
        }

        // --- SEARCH LOGIC ---
        function randomCard() {
            resetView();
            if (typeof HERITAGE_DB === 'undefined') return;
            const r = Math.floor(Math.random() * HERITAGE_DB.length);
            const card = HERITAGE_DB[r];
            loadFromSelection(card);
        }

        function randomCommander() {
            resetView();
            if (typeof HERITAGE_DB === 'undefined') return;
            const commanders = HERITAGE_DB.filter(c => c.t.includes("Legendary") && c.t.includes("Creature") && !c.b);
            if (commanders.length > 0) {
                const r = Math.floor(Math.random() * commanders.length);
                const card = commanders[r];
                loadFromSelection(card);
            }
        }

        function resetView() {
            advResults.innerHTML = '';
            loadMoreBtn.style.display = 'none';
            statusText.innerText = '';
            mainSuggestions.style.display = 'none';
        }

        function loadFromSelection(card) {
            input.value = card.n;
            selectCard(card);
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?card=' + encodeURIComponent(card.n);
            window.history.pushState({path:newUrl},'',newUrl);
        }

        function attachPredictive(inputElem, suggestionElem, dataKey) {
            inputElem.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                if (query.length < 2) { suggestionElem.style.display = 'none'; return; }
                if (typeof HERITAGE_DB === 'undefined') return;

                let matches = [];
                let seen = new Set();
                
                for (const card of HERITAGE_DB) {
                    if (dataKey === 't') { 
                        const words = card.t.split(' ');
                        for (const w of words) {
                            if (w.toLowerCase().startsWith(query) && !seen.has(w)) {
                                matches.push(w);
                                seen.add(w);
                            }
                        }
                    } else if (dataKey === 's') { 
                         if (card.s.toLowerCase().startsWith(query) && !seen.has(card.s)) {
                            matches.push(card.s);
                            seen.add(card.s);
                         }
                    }
                    if (matches.length >= 5) break;
                }

                if (matches.length > 0) {
                    suggestionElem.innerHTML = '';
                    matches.forEach(match => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.innerText = match;
                        div.onclick = function() {
                            inputElem.value = match;
                            suggestionElem.style.display = 'none';
                        };
                        suggestionElem.appendChild(div);
                    });
                    suggestionElem.style.display = 'block';
                } else {
                    suggestionElem.style.display = 'none';
                }
            });

            document.addEventListener('click', function(e) {
                if (e.target !== inputElem && e.target !== suggestionElem) {
                    suggestionElem.style.display = 'none';
                }
            });
        }

        attachPredictive(typeInput, typeSuggestions, 't');
        attachPredictive(setInput, setSuggestions, 's');

        input.addEventListener('input', function() {
            advResults.innerHTML = ''; 
            loadMoreBtn.style.display = 'none';
            statusText.innerText = '';
            
            const query = this.value.trim().toLowerCase();
            if (query.length < 2) { 
                mainSuggestions.style.display = 'none';
                display.style.display = 'none'; 
                input.style.borderRadius = "8px"; 
                return; 
            }
            
            const matches = HERITAGE_DB.filter(c => c.n.toLowerCase().startsWith(query)).slice(0, 5);
            if (matches.length > 0) {
                mainSuggestions.innerHTML = '';
                matches.forEach(card => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `<span>${card.n}</span> <span style="font-size:0.8em; opacity:0.5">${card.s}</span>`;
                    div.onclick = function() { 
                        loadFromSelection(card);
                    };
                    mainSuggestions.appendChild(div);
                });
                mainSuggestions.style.display = 'block';
                input.style.borderRadius = "8px 8px 0 0"; 
            } else {
                mainSuggestions.style.display = 'none';
                input.style.borderRadius = "8px";
            }
            const exactCard = HERITAGE_DB.find(c => c.n.toLowerCase() === query);
            if (exactCard) {
                renderSingleCard(exactCard, true);
                display.style.display = 'block';
            }
        });

        function selectCard(card) {
            mainSuggestions.style.display = 'none';
            input.style.borderRadius = "8px";
            display.style.display = 'block';
            renderSingleCard(card, true);
        }

        function renderSingleCard(card, isLegal) {
            currentCard = card;
            isFlipped = false; 
            
            const uiImg = document.getElementById('cardImg');
            const uiName = document.getElementById('cardName');
            const uiBadge = document.getElementById('statusBadge');
            const uiSet = document.getElementById('setInfo');
            const uiType = document.getElementById('typeLine');
            const uiOracle = document.getElementById('oracleText');
            const uiMsg = document.getElementById('msgText');
            
            uiName.innerText = card.n;
            flipBtn.innerText = "â†» FLIP CARD"; 
            scryfallBtn.href = `https://scryfall.com/search?q=!"${encodeURIComponent(card.n)}"`;

            if (isLegal) {
                uiImg.src = card.i;
                const setIconUrl = `https://svgs.scryfall.io/sets/${card.sc}.svg`;
                uiSet.innerHTML = `Heritage Source: <img src="${setIconUrl}" class="set-icon"> ${card.s}`;
                uiType.innerText = card.t; 
                uiOracle.innerText = card.o || "";
                uiOracle.style.display = card.o ? "block" : "none";

                if (card.b) {
                    uiBadge.innerText = "BANNED";
                    uiBadge.className = "status-badge banned";
                    uiMsg.innerText = "Legal in Heritage sets, but Banned in Commander.";
                    document.getElementById('cardDisplay').style.borderColor = "#b71c1c";
                    addDeckBtn.style.display = "none";
                } else {
                    uiBadge.innerText = "LEGAL";
                    uiBadge.className = "status-badge legal";
                    uiMsg.innerText = "Authorized for Heritage Play.";
                    document.getElementById('cardDisplay').style.borderColor = "var(--legal)";
                    addDeckBtn.style.display = "inline-block";
                }

                if (card.bi) {
                    flipBtn.style.display = "inline-block";
                } else {
                    flipBtn.style.display = "none";
                }

            } else {
                uiImg.src = ""; 
                uiBadge.innerText = "ILLEGAL";
                uiBadge.className = "status-badge illegal";
                uiSet.innerText = "Not found in Heritage-legal sets";
                uiType.innerText = "";
                uiOracle.innerText = "";
                uiOracle.style.display = "none";
                flipBtn.style.display = "none";
                addDeckBtn.style.display = "none";
                uiMsg.innerText = "This card was never printed in a Standard-legal set.";
                document.getElementById('cardDisplay').style.borderColor = "var(--illegal)";
            }
        }

        function flipCard() {
            if (!currentCard || !currentCard.bi) return;
            isFlipped = !isFlipped;
            const uiImg = document.getElementById('cardImg');
            const uiOracle = document.getElementById('oracleText');
            if (isFlipped) {
                uiImg.src = currentCard.bi;
                uiOracle.innerText = currentCard.bo || "(No text on back)";
                flipBtn.innerText = "â†» FLIP BACK";
            } else {
                uiImg.src = currentCard.i;
                uiOracle.innerText = currentCard.o || "";
                flipBtn.innerText = "â†» FLIP CARD";
            }
        }

        function toggleAdv() {
            const panel = document.getElementById('advPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function resetFilters() {
            document.getElementById('rulesInput').value = "";
            document.getElementById('typeInput').value = "";
            document.getElementById('setInput').value = "";
            document.getElementById('cmcMin').value = "";
            document.getElementById('cmcMax').value = "";
            document.querySelectorAll('.mana-check-input').forEach(cb => cb.checked = false);
            document.getElementById('sortSelect').value = "name";
        }

        function runAdvancedSearch() {
            display.style.display = 'none'; 
            advResults.innerHTML = 'Searching...';
            loadMoreBtn.style.display = 'none';
            statusText.innerText = '';
            
            const rulesQ = document.getElementById('rulesInput').value.toLowerCase();
            const typeQ = document.getElementById('typeInput').value.toLowerCase();
            const typeTokens = typeQ.split(' ').filter(t => t.length > 0);
            const setQ = document.getElementById('setInput').value.toLowerCase();
            const minCMC = parseFloat(document.getElementById('cmcMin').value) || 0;
            const maxCMC = document.getElementById('cmcMax').value === "" ? 99 : parseFloat(document.getElementById('cmcMax').value);
            
            const checkedValues = Array.from(document.querySelectorAll('.mana-check-input:checked')).map(cb => cb.value);
            const isLandChecked = checkedValues.includes("LAND");
            const isColorlessChecked = checkedValues.includes("C");
            const selectedColors = checkedValues.filter(v => v !== "LAND" && v !== "C");
            
            const sortMode = document.getElementById('sortSelect').value;

            allMatches = HERITAGE_DB.filter(c => {
                if (rulesQ) {
                    const frontText = c.o ? c.o.toLowerCase() : "";
                    const backText = c.bo ? c.bo.toLowerCase() : "";
                    if (!frontText.includes(rulesQ) && !backText.includes(rulesQ)) return false;
                }
                
                if (typeTokens.length > 0) {
                    const cardTypeLower = c.t.toLowerCase();
                    if (!typeTokens.every(token => cardTypeLower.includes(token))) return false;
                }
                
                if (isLandChecked && !c.t.toLowerCase().includes("land")) return false;
                if (setQ && !c.s.toLowerCase().includes(setQ)) return false;
                if (c.v < minCMC || c.v > maxCMC) return false;
                
                if (isColorlessChecked) {
                    if (c.c.length !== 0) return false;
                } else if (selectedColors.length > 0) {
                    if (c.c.length !== selectedColors.length) return false;
                    if (!selectedColors.every(col => c.c.includes(col))) return false;
                }
                return true;
            });

            if (sortMode === 'name') {
                allMatches.sort((a, b) => a.n.localeCompare(b.n));
            } else if (sortMode === 'cmc-asc') {
                allMatches.sort((a, b) => a.v - b.v);
            } else if (sortMode === 'cmc-desc') {
                allMatches.sort((a, b) => b.v - a.v);
            } else if (sortMode === 'date') {
                allMatches.sort((a, b) => a.d.localeCompare(b.d));
            }

            advResults.innerHTML = '';
            displayedCount = 0;

            if (allMatches.length === 0) {
                statusText.innerText = 'No cards found matching criteria.';
                return;
            }
            loadMore();
        }

        function loadMore() {
            const nextBatch = allMatches.slice(displayedCount, displayedCount + BATCH_SIZE);
            nextBatch.forEach(card => {
                const div = document.createElement('div');
                div.className = 'mini-card';
                div.innerHTML = `
                    <img class="mini-img" src="${card.i}">
                    <div class="mini-info">
                        <span class="mini-name">${card.n}</span>
                        <span class="mini-set">${card.s}</span>
                    </div>
                `;
                div.onclick = () => {
                    loadFromSelection(card);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };
                advResults.appendChild(div);
            });
            displayedCount += nextBatch.length;
            statusText.innerText = `Showing ${displayedCount} of ${allMatches.length} matches.`;
            if (displayedCount < allMatches.length) {
                loadMoreBtn.style.display = 'block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
    </script>
</body>

</html>
